<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sonauto Proxy â€” PRO Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">Sonauto Proxy â€” PRO</h1>
      <div class="text-sm text-gray-600">Status: <span id="statusBadge" class="font-medium text-green-600">Ready</span>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-1 bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Generate</h2>

        <label class="block text-sm mb-1">ModÃ¨le (Engine)</label>
        <select id="engine" class="w-full p-2 border rounded mb-3">
          <option value="sonauto">Sonauto</option>
          <option value="acestep">ACE-Step</option>
        </select>

        <label class="block text-sm mb-1">Mode</label>
        <select id="mode" class="w-full p-2 border rounded mb-3">
          <option value="custom">Paroles (custom)</option>
          <option value="prompt">Prompt</option>
          <option value="instrumental">Instrumental</option>
        </select>

        <div id="fieldLyrics" class="mb-3">
          <label class="block text-sm">Paroles</label>
          <textarea id="lyrics" rows="4"
            class="w-full p-2 border rounded">JÃ©sus tu es mon tout, ma lumiÃ¨re, ma foi, mon roi, mon secours chaque jour.</textarea>
        </div>

        <div id="fieldPrompt" class="hidden mb-3">
          <label class="block text-sm">Prompt</label>
          <input id="prompt" class="w-full p-2 border rounded"
            value="A calm pop ballad with warm piano and emotional vocals about love and hope." />
        </div>

        <label class="block text-sm mb-1">Tags (comma separated)</label>
        <input id="tags" class="w-full p-2 border rounded mb-3" value="ballad,worship,emotional,modern" />

        <label class="block text-sm mb-1">Client key (optional)</label>
        <input id="clientKey" class="w-full p-2 border rounded mb-3"
          placeholder="X-CLIENT-KEY header if used on server" />

        <button id="btnGenerate" class="w-full bg-indigo-600 text-white p-3 rounded font-semibold">ðŸŽµ GÃ©nÃ©rer 2
          pistes</button>
      </section>

      <section class="lg:col-span-2 bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Tasks & Logs</h2>
          <div class="flex gap-2">
            <button id="btnClear" class="px-3 py-1 bg-gray-200 rounded">Clear</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm">Task ID</label>
            <input id="taskId" class="w-full p-2 border rounded mb-2" placeholder="task-id..." />
            <div class="flex gap-2">
              <button id="btnCheck" class="px-3 py-2 bg-yellow-500 rounded text-white">ðŸ”Ž VÃ©rifier</button>
            </div>
            <div class="mt-4">
              <h3 class="font-medium mb-2">Tracks</h3>
              <ul id="tracks" class="space-y-2"></ul>
            </div>
          </div>

          <div>
            <h3 class="font-medium mb-2">Logs</h3>
            <pre id="log" class="h-72 overflow-auto p-3 bg-black text-green-200 rounded text-sm"></pre>
          </div>
        </div>
      </section>
    </div>

    <footer class="mt-6 text-sm text-gray-600">
      <p>Keep AUTO_DOWNLOAD=false on Render. To persist tracks, configure S3 and set AWS env vars.</p>
    </footer>
  </div>

  <script>
    const apiBase = '';
    function log(msg) {
      const el = document.getElementById('log');
      el.textContent = new Date().toISOString() + ' | ' + msg + "\n" + el.textContent;
    }
    function setStatusText(t) { document.getElementById('statusBadge').textContent = t; }

    document.getElementById('mode').addEventListener('change', (e) => {
      const m = e.target.value;
      document.getElementById('fieldLyrics').style.display = m === 'custom' ? 'block' : 'none';
      document.getElementById('fieldPrompt').style.display = (m === 'prompt' || m === 'instrumental') ? 'block' : 'none';
    });

    document.getElementById('btnGenerate').addEventListener('click', async () => {
      setStatusText('Submitting...');
      const mode = document.getElementById('mode').value;
      const engine = document.getElementById('engine').value;
      const payload = { mode, engine };
      if (mode === 'custom') payload.lyrics = document.getElementById('lyrics').value;
      if (mode === 'prompt' || mode === 'instrumental') payload.prompt = document.getElementById('prompt').value;
      payload.tags = document.getElementById('tags').value.split(',').map(s => s.trim());
      const clientKey = document.getElementById('clientKey').value.trim();

      try {
        const r = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(clientKey ? { 'X-CLIENT-KEY': clientKey } : {}) },
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (data.status === 'SUBMITTED' || data.taskId) {
          log('Submitted: ' + data.taskId);
          document.getElementById('taskId').value = data.taskId;
          setStatusText('Submitted');
          pollStatusAndShow(data.taskId);
        } else {
          log('Error: ' + JSON.stringify(data));
          setStatusText('Error');
        }
      } catch (err) {
        log('Request failed: ' + err.message);
        setStatusText('Error');
      }
    });

    document.getElementById('btnCheck').addEventListener('click', async () => {
      const taskId = document.getElementById('taskId').value.trim();
      if (!taskId) { alert('Renseigne un task ID'); return; }
      pollStatusAndShow(taskId);
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('log').textContent = '';
      document.getElementById('tracks').innerHTML = '';
      setStatusText('Ready');
    });

    async function pollStatusAndShow(taskId) {
      setStatusText('Polling...');
      for (let i = 0; i < 60; i++) {
        try {
          const r = await fetch('/status/' + encodeURIComponent(taskId));
          const d = await r.json();
          log('Status: ' + d.status);
          if (d.status === 'SUCCESS') {
            setStatusText('Success');
            showTracks(d.song_paths || []);
            return;
          }
          if (d.status === 'FAILURE') {
            setStatusText('Failure');
            log('Failure: ' + (d.error_message || 'unknown'));
            return;
          }
        } catch (err) {
          log('Poll error: ' + err.message);
          setStatusText('Error');
          return;
        }
        await new Promise(r => setTimeout(r, 4000));
      }
      setStatusText('Timeout');
      log('Polling timeout');
    }

    function showTracks(urls) {
      const ul = document.getElementById('tracks');
      ul.innerHTML = '';
      urls.forEach((u, i) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-3 border rounded';
        const name = document.createElement('div');
        name.innerHTML = '<strong>Track ' + (i + 1) + '</strong><div class="text-xs text-gray-500">' + u + '</div>';
        const actions = document.createElement('div');
        actions.className = 'flex gap-2';
        const open = document.createElement('a');
        open.href = u;
        open.target = '_blank';
        open.className = 'px-3 py-1 bg-indigo-600 text-white rounded';
        open.textContent = u.startsWith('/') ? 'Download' : 'Open';
        actions.appendChild(open);
        if (!u.startsWith('/')) {
          const proxy = document.createElement('a');
          proxy.href = '/download?url=' + encodeURIComponent(u);
          proxy.className = 'px-3 py-1 bg-green-600 text-white rounded';
          proxy.textContent = 'Download (proxy)';
          actions.appendChild(proxy);
        }
        li.appendChild(name);
        li.appendChild(actions);
        ul.appendChild(li);
      });
      log('Tracks shown: ' + urls.length);
    }
  </script>
</body>

</html>